from aiogram import Router
from aiogram.types import Message
from aiogram.filters import Command

from services.db import DB
from keyboards.kb import choose_plan_kb, main_inline_kb

router = Router()


@router.message(Command("start"))
async def cmd_start(message: Message, db: DB):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, —É—á—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ."""
    user = await db.ensure_user(message.from_user.id)

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π (–µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª —Ç–∞—Ä–∏—Ñ)
    if not user.get("plan"):
        await message.answer(
            text=(
                "üîÆ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä —Ü–µ–Ω –∏ —Å–∫–∏–¥–æ–∫!</b>\n\n"
                "–Ø ‚Äî –≤–∞—à Telegram-–±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω –Ω–∞ Wildberries.\n\n"
                "‚ú® –ß—Ç–æ —è —É–º–µ—é:\n"
                "‚ö° –£–≤–µ–¥–æ–º–ª—è—Ç—å –æ —Å–Ω–∏–∂–µ–Ω–∏–∏ —Ü–µ–Ω\n"
                "üìà –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥–∏–Ω–∞–º–∏–∫—É —Å—Ç–æ–∏–º–æ—Å—Ç–∏\n"
                "üìä –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞\n\n"
                "üéÅ <b>–ü–µ—Ä–≤—ã–µ 5 —Ç–æ–≤–∞—Ä–æ–≤</b> –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ.\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å üëá"
            ),
            reply_markup=choose_plan_kb(),
            parse_mode="HTML",
        )

    # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –µ—Å—Ç—å —Ç–∞—Ä–∏—Ñ ‚Üí
    # –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
    else:
        plan = user.get("plan_name", "–í–∞—à —Ç–∞—Ä–∏—Ñ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ü§î")
        await message.answer(
            text=(
                f"üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, <b>{message.from_user.first_name}</b>!\n\n"
                f"üì¶ –í–∞—à —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ: <b>{plan}</b>\n"
                "–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ üëá"
            ),
            reply_markup=main_inline_kb(),
            parse_mode="HTML",
        )
